# ì‘ì—… ë‚´ì—­ì„œ: ì´ë¯¸ì§€ ì €ì¥ ë¬¸ì œ í•´ê²°

**ì‘ì„±ì¼:** 2026-01-25  
**ìƒíƒœ:** ì§„í–‰ ì¤‘ (í…ŒìŠ¤íŠ¸ ëŒ€ê¸°)

---

## 1. ë¬¸ì œ ì •ì˜

### ì£¼ìš” ì¦ìƒ
- ìµìŠ¤í…ì…˜ì—ì„œ ì‡¼í•‘ëª° ìƒí’ˆ ì €ì¥ ì‹œ ì œí’ˆ ì •ë³´ëŠ” ì €ì¥ë˜ì§€ë§Œ **ì´ë¯¸ì§€ê°€ "No Image"ë¡œ í‘œì‹œë¨**
- ëª¨ë“  ì‡¼í•‘ëª°ì—ì„œ ê³µí†µì ìœ¼ë¡œ ë°œìƒ (ì¿ íŒ¡, ë„¤ì´ë²„ ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´, AliExpress, eBay, ì˜¤ëŠ˜ì˜ì§‘ ë“±)
- Content Scriptì—ì„œëŠ” ì´ë¯¸ì§€ URLì„ ì •ìƒì ìœ¼ë¡œ ìˆ˜ì§‘í•˜ì§€ë§Œ, Popupì—ì„œ ì´ë¯¸ì§€ ì²˜ë¦¬ ì‹¤íŒ¨

### ì—ëŸ¬ ë¡œê·¸
```
Content-Security-Policy: net::ERR_FILE_NOT_FOUND
Content-Security-Policy: The page's settings blocked the loading of a resource at ...
```

---

## 2. ê·¼ë³¸ ì›ì¸ ë¶„ì„

### 2.1 ì•„í‚¤í…ì²˜ ë¬¸ì œ
**ì´ˆê¸° ì„¤ê³„:**
- Content Scriptì—ì„œ ì´ë¯¸ì§€ URL ìˆ˜ì§‘
- Content Scriptì—ì„œ ì´ë¯¸ì§€ ì²˜ë¦¬ (fetch, resize, WebP ë³€í™˜)
- Popupìœ¼ë¡œ ì²˜ë¦¬ëœ ì´ë¯¸ì§€ ì „ë‹¬

**ë¬¸ì œì :**
- Content ScriptëŠ” í˜ì´ì§€ì˜ CORS ì •ì±…ì— ì¢…ì†ë¨
- Chrome Extensionì˜ `host_permissions`ê°€ Content Scriptì—ì„œ ì œëŒ€ë¡œ ì‘ë™í•˜ì§€ ì•ŠìŒ
- ì™¸ë¶€ CDN ì´ë¯¸ì§€ fetchê°€ ì°¨ë‹¨ë¨

### 2.2 ì‹œë„í•œ í•´ê²° ë°©ë²• (ì‹¤íŒ¨)

#### ì‹œë„ 1: Content Scriptì—ì„œ ì§ì ‘ ì´ë¯¸ì§€ ì²˜ë¦¬
```typescript
// src/pages/content/index.tsx
const processImageInContent = async (imageUrl: string) => {
  const response = await fetch(imageUrl); // âŒ CORS ì°¨ë‹¨
  // ...
}
```
**ê²°ê³¼:** CORS ì—ëŸ¬, fetch ì‹¤íŒ¨

#### ì‹œë„ 2: Background Service Workerë¥¼ í†µí•œ ì´ë¯¸ì§€ fetch
```typescript
// Content Script â†’ Background â†’ Content Script
chrome.runtime.sendMessage({ type: 'FETCH_IMAGE', url: imageUrl });
```
**ê²°ê³¼:** Background Service Workerë„ ì˜ˆìƒê³¼ ë‹¬ë¦¬ ì—„ê²©í•œ CSP ì ìš©ë¨, fetch ì‹¤íŒ¨

---

## 3. ìµœì¢… í•´ê²° ë°©ì•ˆ

### 3.1 ì•„í‚¤í…ì²˜ ì¬ì„¤ê³„
**ìƒˆë¡œìš´ í”Œë¡œìš°:**
```
Content Script (DOM ë¶„ì„)
    â†“ (ìƒí’ˆ ì •ë³´ + ì´ë¯¸ì§€ URLë§Œ ì „ë‹¬)
Popup (ì´ë¯¸ì§€ ì²˜ë¦¬ ì¤‘ì•™í™”)
    â†“ (fetch + processImage + uploadThumbnail)
Supabase Storage
```

**ì´ì :**
- Extension Page(Popup)ëŠ” `host_permissions`ì˜ ëª¨ë“  ê¶Œí•œì„ í™œìš© ê°€ëŠ¥
- CSP ì œì•½ì´ Backgroundë³´ë‹¤ ì ìŒ
- ì´ë¯¸ì§€ ì²˜ë¦¬ ë¡œì§ì´ í•œ ê³³ì— ì§‘ì¤‘

### 3.2 êµ¬í˜„í•œ ìˆ˜ì • ì‚¬í•­

#### ìˆ˜ì • 1: Content Script ë‹¨ìˆœí™”
**íŒŒì¼:** `src/pages/content/index.tsx`

**ë³€ê²½ ì „:**
```typescript
// ì´ë¯¸ì§€ ì²˜ë¦¬ê¹Œì§€ ë‹´ë‹¹
const processedImage = await processImageInContent(imageUrl);
sendResponse({ productData: { ...data, processedImage } });
```

**ë³€ê²½ í›„:**
```typescript
// ì´ë¯¸ì§€ URLë§Œ ìˆ˜ì§‘
sendResponse({ 
  productData: { 
    title, price, imageUrl, imageUrls, imageCount 
  } 
});
```

#### ìˆ˜ì • 2: Popupì—ì„œ ì´ë¯¸ì§€ ì²˜ë¦¬ ì¤‘ì•™í™”
**íŒŒì¼:** `src/pages/popup/Popup.tsx`

**í•µì‹¬ ë¡œì§:**
```typescript
const handleSaveToPocket = async (pocketId: string) => {
  // 1. ì´ë¯¸ì§€ URL ê²°ì •
  const targetImageUrl = productData.imageUrls?.[selectedImageIndex] || 
                         productData.imageUrl;
  
  // 2. Popup ì»¨í…ìŠ¤íŠ¸ì—ì„œ ì´ë¯¸ì§€ ì²˜ë¦¬
  logger.log('[Popup] Processing image...', targetImageUrl);
  const processed = await processImage(targetImageUrl);
  logger.log('[Popup] Image processed successfully:', processed);
  
  // 3. Supabase ì—…ë¡œë“œ
  const thumbnailUrl = await uploadThumbnail(user.id, processed.blob);
  
  // 4. ì €ì¥
  await saveItem({
    title: productData.title,
    thumbnail_url: thumbnailUrl,
    blurhash: processed.blurhash,
    // ...
  });
};
```

#### ìˆ˜ì • 3: manifest.json ê¶Œí•œ í™•ì¥
**íŒŒì¼:** `manifest.json`

**ì¶”ê°€ëœ host_permissions:**
```json
{
  "host_permissions": [
    "*://*.pstatic.net/*",        // ë„¤ì´ë²„ CDN
    "*://*.coupangcdn.com/*",     // ì¿ íŒ¡ CDN
    "*://*.alicdn.com/*",         // ì•Œë¦¬ìµìŠ¤í”„ë ˆìŠ¤ CDN
    "*://*.cloudfront.net/*",     // AWS CloudFront
    "*://*.media-amazon.com/*",   // ì•„ë§ˆì¡´ ì´ë¯¸ì§€
    "*://*.ssl-images-amazon.com/*",
    "*://*.brand.naver.com/*"     // ë„¤ì´ë²„ ë¸Œëœë“œìŠ¤í† ì–´
  ]
}
```

#### ìˆ˜ì • 4: Popup CSP ì™„í™”
**íŒŒì¼:** `src/pages/popup/index.html`

**ì¶”ê°€ëœ connect-src:**
```html
<meta http-equiv="Content-Security-Policy" 
      content="connect-src 'self' https://*.supabase.co wss://*.supabase.co 
               https://*.pstatic.net https://*.coupangcdn.com 
               https://*.alicdn.com https://*.cloudfront.net 
               https://*.media-amazon.com https://*.ssl-images-amazon.com https:;">
```

#### ìˆ˜ì • 5: ì—ëŸ¬ ì²˜ë¦¬ ê°•í™”
**íŒŒì¼:** `src/utils/siteDetector.ts`

**ì•ˆì „ì„± ê°œì„ :**
```typescript
export function isLikelyShoppingMall(url: string): boolean {
  if (!url) return false; // undefined ì²´í¬ ì¶”ê°€
  // ...
}

export function detectSiteType(currentUrl: string): SiteType {
  // chrome:// ë° chrome-extension:// URL í•„í„°ë§
  if (!currentUrl || 
      currentUrl.startsWith('chrome://') || 
      currentUrl.startsWith('chrome-extension://')) {
    return 'general';
  }
  // ...
}
```

**í˜¸ì¶œë¶€ ìˆ˜ì •:**
```typescript
const siteType = detectSiteType(tab.url || ''); // ëª…ì‹œì  fallback
```

#### ìˆ˜ì • 6: ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€
**íŒŒì¼:** `src/pages/popup/Popup.tsx`

**ì¶”ê°€ëœ ë¡œê·¸:**
```typescript
logger.log('[Popup] Save started');
logger.log('[Popup] Target image URL:', targetImageUrl);
logger.log('[Popup] Processing image...');
logger.log('[Popup] Image processed successfully:', processed);
logger.log('[Popup] Image processing failed:', error);
logger.log('[Popup] No image URL found, saving without image');
```

---

## 4. í…ŒìŠ¤íŠ¸ í™˜ê²½ êµ¬ì¶• ì‹œë„

### 4.1 ëª©ì 
- ì´ë¯¸ì§€ ì²˜ë¦¬ íŒŒì´í”„ë¼ì¸ì˜ ë‹¨ê³„ë³„ ì„±ê³µ/ì‹¤íŒ¨ ì§€ì  íŒŒì•…
- í˜ì´ì§€ ë¶„ì„ â†’ ì´ë¯¸ì§€ URL ì¶”ì¶œ â†’ Fetch â†’ ì´ë¯¸ì§€ ì²˜ë¦¬ â†’ Supabase ì—…ë¡œë“œ

### 4.2 ì‹œë„í•œ ë°©ë²•
**ìƒì„±ëœ íŒŒì¼:**
- `public/test-full-flow.html` (ìµœì¢…: `test-full-flow.html` ë£¨íŠ¸ë¡œ ì´ë™)
- `public/test-full-flow.js` (ìµœì¢…: `test-full-flow.js` ë£¨íŠ¸ë¡œ ì´ë™)

**ì§ë©´í•œ ë¬¸ì œë“¤:**

#### ë¬¸ì œ 1: Inline Script CSP ì°¨ë‹¨
```
Refused to execute inline script because it violates CSP directive 'script-src'
```
**í•´ê²°:** inline event handler (`onclick`) ì œê±°, `addEventListener` ì‚¬ìš©

#### ë¬¸ì œ 2: Module Import ê²½ë¡œ ì˜¤ë¥˜
```
net::ERR_FILE_NOT_FOUND
```
**í•´ê²°:** Vite `rollupOptions.input`ì— í…ŒìŠ¤íŠ¸ í˜ì´ì§€ ì¶”ê°€, ê²½ë¡œ ì¡°ì •

#### ë¬¸ì œ 3: CORS on Extension Page
```
TypeError: Failed to fetch
```
**ê·¼ë³¸ ì›ì¸:** Extension Pageì—ì„œë„ ì™¸ë¶€ ì‚¬ì´íŠ¸ë¥¼ ì§ì ‘ fetchí•  ìˆ˜ ì—†ìŒ (í…ŒìŠ¤íŠ¸ í˜ì´ì§€ì˜ í•œê³„)

### 4.3 ê²°ë¡ 
- **í…ŒìŠ¤íŠ¸ í˜ì´ì§€ ë°©ì‹ì€ Chrome Extensionì˜ ë³´ì•ˆ ëª¨ë¸ ìƒ í•œê³„ê°€ ìˆìŒ**
- **ì‹¤ì œ Popupì—ì„œ ì§ì ‘ í…ŒìŠ¤íŠ¸í•˜ëŠ” ê²ƒì´ ìœ ì¼í•œ ë°©ë²•**

---

## 5. í˜„ì¬ ìƒíƒœ

### 5.1 ì™„ë£Œëœ ì‘ì—…
- âœ… Content Script ì´ë¯¸ì§€ ì²˜ë¦¬ ë¡œì§ ì œê±°
- âœ… Popupì— ì´ë¯¸ì§€ ì²˜ë¦¬ ë¡œì§ ì¤‘ì•™í™”
- âœ… `manifest.json` host_permissions í™•ì¥
- âœ… Popup CSP connect-src í™•ì¥
- âœ… ì—ëŸ¬ ì²˜ë¦¬ ê°•í™” (undefined URL ì²´í¬)
- âœ… ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€
- âœ… ë¹Œë“œ ì„±ê³µ (`npm run build:extension`)

### 5.2 í…ŒìŠ¤íŠ¸ ëŒ€ê¸° ì¤‘
**í…ŒìŠ¤íŠ¸ ë°©ë²•:**
1. ì¿ íŒ¡ ìƒí’ˆ í˜ì´ì§€ ì ‘ì†
2. ìµìŠ¤í…ì…˜ Popup ì—´ê¸°
3. F12 â†’ Consoleì—ì„œ ë¡œê·¸ ëª¨ë‹ˆí„°ë§
4. "ì €ì¥í•˜ê¸°" ë²„íŠ¼ í´ë¦­
5. ì½˜ì†”ì—ì„œ ë‹¤ìŒ ë¡œê·¸ í™•ì¸:
   - `[Popup] Target image URL:`
   - `[Popup] Processing image...`
   - `[Popup] Image processed successfully:` ë˜ëŠ” `[Popup] Image processing failed:`

**ì˜ˆìƒ ê²°ê³¼:**
- `processImage()` í•¨ìˆ˜ê°€ ì •ìƒ ì‹¤í–‰
- ì´ë¯¸ì§€ fetch ì„±ê³µ
- WebP ë³€í™˜ ë° BlurHash ìƒì„± ì„±ê³µ
- Supabase Storage ì—…ë¡œë“œ ì„±ê³µ

---

## 6. ë‹¤ìŒ ë‹¨ê³„

### í…ŒìŠ¤íŠ¸ í†µê³¼ ì‹œ
1. ë‹¤ì–‘í•œ ì‡¼í•‘ëª°ì—ì„œ ì¶”ê°€ í…ŒìŠ¤íŠ¸
2. ë””ë²„ê¹… ë¡œê·¸ ì œê±° (production ë¹Œë“œ ì „)
3. Git commit ë° Vercel ë°°í¬

### í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ì‹œ
**ì²´í¬ í¬ì¸íŠ¸:**
- `[Popup] Target image URL`ì´ ì˜¬ë°”ë¥¸ URLì¸ì§€ í™•ì¸
- `processImage()` í•¨ìˆ˜ ë‚´ë¶€ ì—ëŸ¬ ìŠ¤íƒ ë¶„ì„
- `fetch()` ì‘ë‹µ ìƒíƒœ í™•ì¸
- `manifest.json` host_permissionsì— í•´ë‹¹ CDN ë„ë©”ì¸ í¬í•¨ ì—¬ë¶€ í™•ì¸
- Supabase Storage ê¶Œí•œ í™•ì¸

---

## 7. íŒŒì¼ ë³€ê²½ ì´ë ¥

### ìˆ˜ì •ëœ íŒŒì¼
1. `src/pages/content/index.tsx` - ì´ë¯¸ì§€ ì²˜ë¦¬ ë¡œì§ ì œê±°
2. `src/pages/popup/Popup.tsx` - ì´ë¯¸ì§€ ì²˜ë¦¬ ì¤‘ì•™í™”, ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€
3. `src/utils/parser.ts` - `processedImage` ì†ì„± ì œê±°
4. `src/utils/siteDetector.ts` - undefined URL ì²´í¬ ì¶”ê°€
5. `manifest.json` - host_permissions í™•ì¥
6. `src/pages/popup/index.html` - CSP connect-src í™•ì¥
7. `vite.config.ts` - í…ŒìŠ¤íŠ¸ í˜ì´ì§€ entry point ì¶”ê°€

### ì¶”ê°€ëœ íŒŒì¼
1. `test-full-flow.html` - í…ŒìŠ¤íŠ¸ í˜ì´ì§€ (ì‚¬ìš© ë¶ˆê°€ íŒì •)
2. `test-full-flow.js` - í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸ (ì‚¬ìš© ë¶ˆê°€ íŒì •)

---

## 8. ê¸°ìˆ ì  êµí›ˆ

### Chrome Extension ë³´ì•ˆ ëª¨ë¸
1. **Content ScriptëŠ” í˜ì´ì§€ì˜ CORS ì •ì±…ì„ ë”°ë¦„**
   - `host_permissions`ì´ ìˆì–´ë„ Content Scriptì—ì„œ ì§ì ‘ fetchëŠ” ì œí•œì 
   
2. **Background Service Workerë„ ì˜ˆìƒë³´ë‹¤ ì œí•œì **
   - Manifest V3ì˜ Service WorkerëŠ” ì—„ê²©í•œ CSP ì ìš©
   
3. **Extension Page(Popup, Options ë“±)ê°€ ê°€ì¥ ììœ ë¡œì›€**
   - `host_permissions`ì˜ ëª¨ë“  ê¶Œí•œ í™œìš© ê°€ëŠ¥
   - ì´ë¯¸ì§€ ì²˜ë¦¬ ê°™ì€ ë¦¬ì†ŒìŠ¤ ì§‘ì•½ì  ì‘ì—…ì— ì í•©

### ì•„í‚¤í…ì²˜ ì„¤ê³„ ì›ì¹™
- **Content Script: ìµœì†Œí•œì˜ DOM ë¶„ì„ë§Œ**
- **Popup/Extension Page: ë°ì´í„° ì²˜ë¦¬ ë° API í†µì‹ **
- **Background: í•„ìˆ˜ ë°±ê·¸ë¼ìš´ë“œ ì‘ì—…ë§Œ (ì•Œë¦¼, ìƒíƒœ ê´€ë¦¬ ë“±)**

---

---

## 9. ì¶”ê°€ ì‘ì—… (2026-01-25 15:00)

### 9.1 ë””ë²„ê¹… ë¡œê·¸ ê°•í™” ì™„ë£Œ âœ…
**íŒŒì¼:** `src/utils/imageOptimizer.ts`

**ì¶”ê°€ëœ ë¡œê·¸:**
- `[ImageOptimizer] Starting process for:` - ì´ë¯¸ì§€ URL
- `[ImageOptimizer] Fetching image...`
- `[ImageOptimizer] Fetch response:` - HTTP ìƒíƒœ, Content-Type, Content-Length
- `[ImageOptimizer] Blob created:` - Blob í¬ê¸°, íƒ€ì…
- `[ImageOptimizer] Image loaded successfully:` - ì›ë³¸ í¬ê¸°
- `[ImageOptimizer] Resizing:` - ì›ë³¸ vs ë¦¬ì‚¬ì´ì¦ˆ í¬ê¸°
- `[ImageOptimizer] Generating blurhash...`
- `[ImageOptimizer] Blurhash generated:` - BlurHash ë¬¸ìì—´
- `[ImageOptimizer] Converting to WebP...`
- `[ImageOptimizer] WebP conversion successful:` - ìµœì¢… í¬ê¸°, ì••ì¶•ë¥ 
- `[ImageOptimizer] Uploading to Supabase Storage...` - ì‚¬ìš©ì ID, Blob ì •ë³´
- `[ImageOptimizer] Upload path:` - Supabase Storage ê²½ë¡œ
- `[ImageOptimizer] Upload successful:` - Upload ì‘ë‹µ ë°ì´í„°
- `[ImageOptimizer] Public URL generated:` - ìµœì¢… ê³µê°œ URL

**ì—ëŸ¬ ë¡œê·¸:**
- `[ImageOptimizer] Image load error:` - ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨ ì‹œ
- `[ImageOptimizer] Process failed:` - ì „ì²´ í”„ë¡œì„¸ìŠ¤ ì‹¤íŒ¨ ì‹œ
- `[ImageOptimizer] Upload failed:` - Supabase ì—…ë¡œë“œ ì‹¤íŒ¨ ì‹œ (ìƒì„¸ ì—ëŸ¬ ì •ë³´ í¬í•¨)

### 9.2 Supabase Storage ì„¤ì • ê°€ì´ë“œ ìƒì„± âœ…
**íŒŒì¼:** `Supabase_Storage_ì„¤ì •ê°€ì´ë“œ.md`

**í¬í•¨ ë‚´ìš©:**
1. Supabase ëŒ€ì‹œë³´ë“œ ì ‘ì† ë°©ë²•
2. `pockest` ë²„í‚· ìƒì„± ë° ì„¤ì •
3. RLS ì •ì±… ì„¤ì • (INSERT, SELECT, DELETE)
4. í…ŒìŠ¤íŠ¸ ì—…ë¡œë“œ ë°©ë²•
5. ì—ëŸ¬ ìœ í˜•ë³„ í•´ê²°ì±…
6. ë””ë²„ê¹… íŒ (Network íƒ­, Supabase Logs)

### 9.3 ë¹Œë“œ ì™„ë£Œ
```bash
npm run build:extension
âœ“ built in 7.50s
```

**ë³€ê²½ ì‚¬í•­:**
- `imageOptimizer-DCQhHDH4.js` (4.49 kB) - ë¡œê·¸ ì¶”ê°€ë¡œ íŒŒì¼ í¬ê¸° ì¦ê°€

---

**ìµœì¢… ì—…ë°ì´íŠ¸:** 2026-01-25 15:00 (í…ŒìŠ¤íŠ¸ ì¤€ë¹„ ì™„ë£Œ)

**ë‹¤ìŒ ë‹¨ê³„:**
1. ğŸ”´ **ìµœìš°ì„ :** Supabase Storage ì„¤ì • í™•ì¸ (`Supabase_Storage_ì„¤ì •ê°€ì´ë“œ.md` ì°¸ê³ )
2. ìµìŠ¤í…ì…˜ ìƒˆë¡œê³ ì¹¨
3. ì¿ íŒ¡ ìƒí’ˆ í˜ì´ì§€ì—ì„œ ì €ì¥ í…ŒìŠ¤íŠ¸
4. Console ë¡œê·¸ í™•ì¸ ë° ìŠ¤í¬ë¦°ìƒ· ì „ë‹¬
